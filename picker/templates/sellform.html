{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Registration Form{% endblock %}

{% block content %}

<h1>Stock - Sell</h1>
<hr>
</br>

<br>
<a href="{% url 'home' %}" class="btn btn-success border-black">Go home</a>
<br>
<br>


<div class="container">
    <div class="container-fluid">
  
        <div class="row">
          <div class="col-sm-12 mb-3 mb-sm-5">  
            <div class="card border-black" style="width: span;">
              <div class="card-body">
              <h3 class="card-title">Sell Transactions</h3>
              <p class="card-text">Maximum selloff of stock portfolio is limited to $5,000.  Once this amount is reached, no other transactions will be processed.</p>



              <table class="table">
                <thead>
                <tr>
                    <th scope="col-3">Stock/Qty/Price</th>
                    <th scope="col-6">Total Transaction</th> 
                 </tr>
                </thead>
                <tbody>
                 {% for value in chosen_items %}

                 <tr>
                    <td>{{ value }}</td>
                    <td class="total">{{ value|slice_from_dollar }}</td>
                 </tr>

                
                 {% endfor %}
                </tbody>
              </table>
              <br>
            <strong><div id="sell-running-total">RUNNING TOTAL: $0.00</div></strong>
              <br>
              <button type="reset" id="reset-button">Reset</button>

   
            </div>
          </div>
        </div>
    </div>
</div>


<script>
// Function to calculate the running total
function calculateRunningTotal() {
    let totalSum = 0;
    const maxTotal = 5000;

    // Select all elements with the class 'total' which contains the total transaction values
    const totals = document.querySelectorAll('.total');
  
    // Iterate over the NodeList and sum the values
    totals.forEach(total => {
        // Parse the text content as a float (remove dollar sign and parse to float)
        const value = parseFloat(total.textContent.replace('$', '').replace(',', ''));
        if (!isNaN(value)) {
            if (totalSum + value <= maxTotal) {
            totalSum += value; // Only add valid numbers
        }
        else {
            totalSum = maxTotal; // Set totalSum to maxTotal if limit is reached     
        }
        }
    });

    // Update the running total display
    document.getElementById('sell-running-total').textContent = `RUNNING TOTAL: $${totalSum.toFixed(2)}`;
}

// Check if the totalSum exceeds or equals $5000
    if (totalSum >= maxTotal) {
        disableTransactionSubmission(); // Call function to disable transaction submission
    }

// Function to disable transaction submission
function disableTransactionSubmission() {
    const submitButton = document.getElementById('submit-button'); // Adjust based on your submit button's ID
    submitButton.disabled = true; // Disable the submit button
    submitButton.textContent = "Transaction Limit Reached"; // Optional: Change button text
}





// Event listener to calculate the running total on page load
window.addEventListener('DOMContentLoaded', (event) => {
    calculateRunningTotal(); // Calculate total when the page is loaded
});

// Event listener for the reset button
document.getElementById('reset-button').addEventListener('click', function() {
    // Clear the table body
    const tbody = document.querySelector('tbody');
    
    // Remove all rows from tbody
    tbody.innerHTML = '';

    // Reset the running total display
    document.getElementById('sell-running-total').textContent = 'RUNNING TOTAL:';


    // Reset totals to $0.00
    document.querySelectorAll(".total").forEach(function (total) {
        total.textContent = "$0.00";
    });

 // Enable transaction submission again
    const submitButton = document.getElementById('submit-button');
    submitButton.disabled = false; // Re-enable the button
    submitButton.textContent = "Submit Transaction"; // Reset button text

});

// Example code to handle the transaction submission (adjust based on your form handling)
document.getElementById('form-id').addEventListener('submit', function(evt) {
    const totals = document.querySelectorAll('.total');
    let totalSum = 0;

    totals.forEach(total => {
        const value = parseFloat(total.textContent.replace('$', '').replace(',', ''));
        if (!isNaN(value)) {
            totalSum += value; // Accumulate total from elements

    }

});

    if (totalSum >= 5000) {
        evt.preventDefault(); // Prevent the form submission if the limit is reached
        alert("Transaction limit of $5,000 reached. No further transactions can be processed."); // Alert the user

}
    // // Reset totals to $0.00
    // // Clear the rowsAdded set
    // rowsAdded.clear();

});  

</script>
{% endblock %}




<!-- 
// OLD

// document.addEventListener("DOMContentLoaded", function () {
//     let totals = document.querySelectorAll(".total");
//     let sellrunningTotalElement = document.getElementById("sell-running-total");
//     let sellrunningTotal = 0;
//     const maxTotal = 5000;
//     let alertShown = false;
//     let table = document.querySelector("table");
//     let rowsAdded = new Set();  // Track row indexes to prevent duplicates

//     for (let i = 0; i < totals.length; i++) {
//         let amount = parseFloat(totals[i].textContent.replace(/[^0-9.-]+/g, ""));

//         // Check if this row has already been added to avoid duplicates
//         if (!rowsAdded.has(i)) {
//             let row = document.createElement("tr");
//             let cell = document.createElement("td");

//             // If adding this amount would exceed the limit
//             if (sellrunningTotal + amount > maxTotal) {
//                 if (!alertShown) {
//                     alert("Transaction cancelled: You no longer own the required number of stocks to process this transaction.");
//                     alertShown = true;
//                 }

//                 row.style.color = "red";
//                 cell.textContent = totals[i].textContent + " (exceeds limit)";
//             } else {
//                 sellrunningTotal += amount;
//                 cell.textContent = totals[i].textContent;
//                 row.style.color = "green";
//                 cell.textContent = totals[i].textContent + " (valid transaction)";
//             }

//             row.appendChild(cell);
//             table.appendChild(row);
//             rowsAdded.add(i);  // Mark this row as added to avoid duplicates
//         }
//     }

//     // Update the running total display
//     sellrunningTotalElement.textContent = "RUNNING TOTAL: $" + sellrunningTotal.toLocaleString("en-US", {
//         minimumFractionDigits: 2,
//         maximumFractionDigits: 2
//     });
// });


// //***************************************Thursday



// document.getElementById("reset-button").addEventListener("click", function () {
//     // Get the element that shows the running total
//     let sellRunningTotalElement = document.getElementById("sell-running-total");
    
//     // Reset the running total to 0 if the element exists
//     if (sellRunningTotalElement) {
//         sellRunningTotalElement.textContent = "RUNNING TOTAL: $0.00";
//     } else {
//         console.error("Running total element not found!");
//     }
    
//     // Clear the table body by removing all rows
//     let tbody = document.querySelector("table tbody"); // Assuming your table has a <tbody> tag
//     if (tbody) {
//         tbody.innerHTML = ""; // This clears all rows inside the table body
//     } else {
//         console.error("Table body not found!");
//     }


// // *************
// // Clear the table by removing specific rows
//     let table = document.querySelector("table");
//     let rows = table.querySelectorAll("tr");  // Select all rows in the table

//     rows.forEach(function(row, index) {
//         if (row.textContent.includes("exceeds limit") || row.textContent.includes("valid transaction")) {
//             table.deleteRow(index);  // Remove the specific row
//         }
//     });

//     // Reset any other relevant states or flags as necessary
//     alertShown = false;  // Reset alert variable if it's used elsewhere
// }); -->

